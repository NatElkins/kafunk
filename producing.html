<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Producing
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# client for Kafka"/>
    <meta name="author" content="Jet.com"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/kafunk/content/style.css" />
    <script type="text/javascript" src="/kafunk/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/jet/kafunk">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/kafunk/index.html">Kafunk</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Producing" class="anchor" href="#Producing">Producing</a></h1>
<p>This example demonstrates how to produce using Kafunk.</p>
<p>Creating the producer.
See also: (ProducerConfig)[<a href="https://jet.github.io/kafunk/reference/kafunk-producerconfig.html">https://jet.github.io/kafunk/reference/kafunk-producerconfig.html</a>]</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;kafunk.dll&quot;</span>
<span class="prep">#r</span> <span class="s">&quot;FSharp.Control.AsyncSeq.dll&quot;</span>

<span class="k">open</span> <span class="i">Kafunk</span>
<span class="k">open</span> <span class="i">System</span>

<span class="k">let</span> <span class="i">conn</span> <span class="o">=</span> <span class="i">Kafka</span><span class="o">.</span><span class="i">connHost</span> <span class="s">&quot;existential-host&quot;</span>

<span class="c">/// Configuration.</span>
<span class="k">let</span> <span class="i">producerConfig</span> <span class="o">=</span> 
  <span class="i">ProducerConfig</span><span class="o">.</span><span class="i">create</span> (
    
    <span class="c">/// The topic to produce to.</span>
    <span class="i">topic</span> <span class="o">=</span> <span class="s">&quot;absurd-topic&quot;</span>, 

    <span class="c">/// The partition function to use.</span>
    <span class="i">partition</span> <span class="o">=</span> <span class="i">Partitioner</span><span class="o">.</span><span class="i">roundRobin</span>,

    <span class="c">/// The required acks setting.</span>
    <span class="i">requiredAcks</span> <span class="o">=</span> <span class="i">RequiredAcks</span><span class="o">.</span><span class="i">AllInSync</span>,

    <span class="c">/// The per-broker in-memory buffer size, in bytes.</span>
    <span class="i">bufferSizeBytes</span> <span class="o">=</span> <span class="i">ProducerConfig</span><span class="o">.</span><span class="i">DefaultBufferSizeBytes</span>,

    <span class="c">/// The maximum size, in bytes, of an individual produce request.</span>
    <span class="i">batchSizeBytes</span> <span class="o">=</span> <span class="i">ProducerConfig</span><span class="o">.</span><span class="i">DefaultBatchSizeBytes</span>,
    
    <span class="c">/// The maximum time to wait for a batch.</span>
    <span class="i">batchLingerMs</span> <span class="o">=</span> <span class="i">ProducerConfig</span><span class="o">.</span><span class="i">DefaultBatchLingerMs</span>)


<span class="c">/// Create a producer.</span>
<span class="k">let</span> <span class="i">producer</span> <span class="o">=</span> 
  <span class="i">Producer</span><span class="o">.</span><span class="i">create</span> <span class="i">conn</span> <span class="i">producerConfig</span>


<span class="c">/// Create a message.</span>
<span class="k">let</span> <span class="i">m</span> <span class="o">=</span> 
  <span class="i">ProducerMessage</span><span class="o">.</span><span class="i">ofString</span> (
    <span class="i">value</span> <span class="o">=</span> <span class="s">&quot;hello value&quot;</span>, 
    <span class="i">key</span> <span class="o">=</span> <span class="s">&quot;hello key&quot;</span>)


<span class="c">/// Produce a single message.</span>
<span class="k">let</span> <span class="i">prodRes</span> <span class="o">=</span> 
  <span class="i">Producer</span><span class="o">.</span><span class="i">produce</span> <span class="i">producer</span> <span class="i">m</span> 
  <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>

<span class="i">printfn</span> <span class="s">&quot;partition=%i offset=%i&quot;</span> <span class="i">prodRes</span><span class="o">.</span><span class="i">partition</span> <span class="i">prodRes</span><span class="o">.</span><span class="i">offset</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Buffering" class="anchor" href="#Buffering">Buffering</a></h2>
<p>The function <code>Producer.produce</code> accepts a single message, but the producer batches messages internally by partition and broker based on
batching settings specified in the configuration. Bigger batches mean fewer round-trips to the broker, and therefore, greater throughput
at the cost of increased latency.</p>
<p>The batching workflow is as follows. A message is assigned to a partition using the configured partition function. (Note that this operation
depends on cluster state and may change, albeit infrequently). Then, a message is placed into the queue of the broker currently responsible for
the partition along with a reply channel. An independent process consumes the broker queue, buffering to form batches and then sends the
batched produce request to the broker. Once a response is received, all of the outstanding reply channels are acknowledged. The offsets in the
<code>ProducerResponse</code> correspond to the first offsets for the entire batch.</p>
<p>In this way, batching allows many concurrent produce operations to be invoked independently, while keeping the number of network operations low.
Note that care must be taken to ensure message ordering requirements aren't violated.</p>
<h2><a name="Explicit-Batching" class="anchor" href="#Explicit-Batching">Explicit Batching</a></h2>
<p>It is also possible to explicitly batch messages on the client side:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">producerResults</span> <span class="o">=</span>
  <span class="i">Producer</span><span class="o">.</span><span class="i">produceBatched</span> 
    <span class="i">producer</span> 
    [| <span class="i">ProducerMessage</span><span class="o">.</span><span class="i">ofString</span> (<span class="s">&quot;message1&quot;</span>) ; <span class="i">ProducerMessage</span><span class="o">.</span><span class="i">ofString</span> (<span class="s">&quot;message2&quot;</span>) |]
  <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>The <code>Producer.produceBatched</code> takes a collection of messages, groups them by partition and produces in parallel
across partitions but maintaining the input order within partitions. The operation returns an array of ProducerResult
values, one for each partition produced to. The producer result value contains the partition, the offset of the first
message written to the partition and a count of messages written to that partition as part of the batch. Note that this
count doesn't necessarily correspond to the count of messages provided to the operation due to buffering. See above for more
details.</p>
<h2><a name="Contributing-and-copyright" class="anchor" href="#Contributing-and-copyright">Contributing and copyright</a></h2>
<p>The project is hosted on <a href="https://github.com/jet/kafunk">GitHub</a> where you can <a href="https://github.com/jet/kafunk/issues">report issues</a>, fork
the project and submit pull requests. If you're adding a new public API, please also
consider adding <a href="https://github.com/jet/kafunk/docs/content">samples</a> that can be turned into a documentation. You might
also want to read the <a href="https://github.com/jet/kafunk/project/README.md">library design notes</a> to understand how it works.</p>
<p>The library is available under Apache 2.0. For more information see the
<a href="https://github.com/jet/kafunk/project/LICENSE.txt">License file</a> in the GitHub repository.</p>


        </div>
        <div class="span3">
          <img src="/kafunk/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Kafunk</li>
            <li><a href="/kafunk/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/kafunk">Get Library via NuGet</a></li>
            <li><a href="http://github.com/jet/kafunk">Source Code on GitHub</a></li>
            <li><a href="/kafunk/license.html">License</a></li>
            <li><a href="/kafunk/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/kafunk/consuming.html">Consuming</a></li>
            <li><a href="/kafunk/producing.html">Producing</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/kafunk/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/jet/kafunk"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
