<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Consuming
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="description" content="F# client for Kafka"/>
    <meta name="author" content="Jet.com"/>

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet"/>

    <link type="text/css" rel="stylesheet" href="/kafunk/content/style.css" />
    <script type="text/javascript" src="/kafunk/content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://github.com/jet/kafunk">github page</a></li>
        </ul>
        <h3 class="muted"><a href="/kafunk/index.html">Kafunk</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="Consuming" class="anchor" href="#Consuming">Consuming</a></h1>
<p>This example demonstrates how to consume using Kafunk.</p>
<p>Joining the consumer group:
See also: (ConsumerConfig)[<a href="https://jet.github.io/kafunk/reference/kafunk-consumerconfig.html">https://jet.github.io/kafunk/reference/kafunk-consumerconfig.html</a>]</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="prep">#r</span> <span class="s">&quot;kafunk.dll&quot;</span>
<span class="prep">#r</span> <span class="s">&quot;FSharp.Control.AsyncSeq.dll&quot;</span>

<span class="k">open</span> <span class="i">FSharp</span><span class="o">.</span><span class="i">Control</span>
<span class="k">open</span> <span class="i">Kafunk</span>
<span class="k">open</span> <span class="i">System</span>

<span class="k">let</span> <span class="i">conn</span> <span class="o">=</span> <span class="i">Kafka</span><span class="o">.</span><span class="i">connHost</span> <span class="s">&quot;existential-host&quot;</span>

<span class="c">/// Configuration.</span>
<span class="k">let</span> <span class="i">consumerConfig</span> <span class="o">=</span> 
  <span class="i">ConsumerConfig</span><span class="o">.</span><span class="i">create</span> (

    <span class="c">/// The name of the consumer group.</span>
    <span class="i">groupId</span> <span class="o">=</span> <span class="s">&quot;consumer-group&quot;</span>, 

    <span class="c">/// The topic to consume.</span>
    <span class="i">topic</span> <span class="o">=</span> <span class="s">&quot;absurd-topic&quot;</span>)


<span class="c">/// This creates a consumer and joins it to the group.</span>
<span class="k">let</span> <span class="i">consumer</span> <span class="o">=</span>
  <span class="i">Consumer</span><span class="o">.</span><span class="i">create</span> <span class="i">conn</span> <span class="i">consumerConfig</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Consumer-State" class="anchor" href="#Consumer-State">Consumer State</a></h2>
<p>Consumer state consists of consumer group member state, as well as state particular to the consumer group protocol, such
as the set of partitions assigned to the consumer. The state can be retrieved, but note that state changes when group
membership changes.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">consumerState</span> <span class="o">=</span> 
  <span class="i">Consumer</span><span class="o">.</span><span class="i">state</span> <span class="i">consumer</span>
  <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>

<span class="i">printfn</span> <span class="s">&quot;generation_id=%i member_id=%s leader_id=%s assignment_stratgey=%s partitions=%A&quot;</span> 
  <span class="i">consumerState</span><span class="o">.</span><span class="i">generationId</span> <span class="i">consumerState</span><span class="o">.</span><span class="i">memberId</span> <span class="i">consumerState</span><span class="o">.</span><span class="i">leaderId</span> 
  <span class="i">consumerState</span><span class="o">.</span><span class="i">assignmentStrategy</span> <span class="i">consumerState</span><span class="o">.</span><span class="i">assignments</span> 
</code></pre></td>
</tr>
</table>
<h2><a name="Consuming-1" class="anchor" href="#Consuming-1">Consuming</a></h2>
<p>Consume with commit on every message set. In this case, offsets are committed as soon as
a message set is processed. Note that this may result in needless synchronization - since the
strongest delivery model supported is at-least-once, consumers have to be tolerant to
receiving duplicate messages. Therefore, it is acceptable to commit offsets asynchronously.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Consumer</span><span class="o">.</span><span class="i">consume</span> <span class="i">consumer</span> 
  (<span class="k">fun</span> (<span class="i">s</span><span class="o">:</span><span class="i">ConsumerState</span>) (<span class="i">ms</span><span class="o">:</span><span class="i">ConsumerMessageSet</span>) <span class="k">-&gt;</span> <span class="i">async</span> {
    <span class="i">printfn</span> <span class="s">&quot;member_id=%s assignment_strategy=%s topic=%s partition=%i&quot;</span> 
      <span class="i">s</span><span class="o">.</span><span class="i">memberId</span> <span class="i">s</span><span class="o">.</span><span class="i">protocolName</span> <span class="i">ms</span><span class="o">.</span><span class="i">topic</span> <span class="i">ms</span><span class="o">.</span><span class="i">partition</span>
    <span class="k">do!</span> <span class="i">Consumer</span><span class="o">.</span><span class="i">commitOffsets</span> <span class="i">consumer</span> (<span class="i">ConsumerMessageSet</span><span class="o">.</span><span class="i">commitPartitionOffsets</span> <span class="i">ms</span>) })
<span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>Consume with periodic commit. This commits offsets asynchronously thereby eliminating a synchronization in
the critical path.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Consumer</span><span class="o">.</span><span class="i">consumePeriodicCommit</span> <span class="i">consumer</span>
  (<span class="i">TimeSpan</span><span class="o">.</span><span class="i">FromSeconds</span> <span class="n">10.0</span>) 
  (<span class="k">fun</span> (<span class="i">s</span><span class="o">:</span><span class="i">ConsumerState</span>) (<span class="i">ms</span><span class="o">:</span><span class="i">ConsumerMessageSet</span>) <span class="k">-&gt;</span> <span class="i">async</span> {
    <span class="i">printfn</span> <span class="s">&quot;member_id=%s assignment_strategy=%s topic=%s partition=%i&quot;</span> 
      <span class="i">s</span><span class="o">.</span><span class="i">memberId</span> <span class="i">s</span><span class="o">.</span><span class="i">protocolName</span> <span class="i">ms</span><span class="o">.</span><span class="i">topic</span> <span class="i">ms</span><span class="o">.</span><span class="i">partition</span> })
<span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Periodic-Offset-Commit" class="anchor" href="#Periodic-Offset-Commit">Periodic Offset Commit</a></h2>
<p><code>Consumer.consumePeriodicCommit</code> commits offsets periodically using the following mechanism.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// Create a commit queue</span>
<span class="k">let</span> <span class="i">commitQueue</span> <span class="o">=</span> <span class="i">Offsets</span><span class="o">.</span><span class="i">createPeriodicCommitQueue</span> (<span class="i">TimeSpan</span><span class="o">.</span><span class="i">FromHours</span> <span class="n">1.0</span>, <span class="i">async</span> { <span class="k">return</span> <span class="i">failwith</span> <span class="s">&quot;&quot;</span> }, <span class="i">Consumer</span><span class="o">.</span><span class="i">commitOffsets</span> <span class="i">consumer</span>)

<span class="k">let</span> <span class="i">ms</span> <span class="o">:</span> <span class="i">ConsumerMessageSet</span> <span class="o">=</span> <span class="i">failwith</span> <span class="s">&quot;some message set&quot;</span>

<span class="c">/// Asynchronously enqueue offsets to be committed.</span>
<span class="i">Offsets</span><span class="o">.</span><span class="i">enqueuePeriodicCommit</span> <span class="i">commitQueue</span> (<span class="i">ConsumerMessageSet</span><span class="o">.</span><span class="i">commitPartitionOffsets</span> <span class="i">ms</span>)
</code></pre></td>
</tr>
</table>
<p>The commit queue will commit enqueued offsets periodically. It will commit the greatest offset enqueued by partition.</p>
<h2><a name="Streaming" class="anchor" href="#Streaming">Streaming</a></h2>
<p>In order to have explicit control of buffering and parallelism, or to perform other streaming operations, it is possible
to consume messages directly using an asynchronous sequence:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Consumer</span><span class="o">.</span><span class="i">stream</span> <span class="i">consumer</span>
<span class="o">|&gt;</span> <span class="i">AsyncSeq</span><span class="o">.</span><span class="i">iterAsync</span> (<span class="k">fun</span> (<span class="i">s</span>,<span class="i">ms</span>) <span class="k">-&gt;</span> <span class="i">async</span> {
  <span class="i">printfn</span> <span class="s">&quot;member_id=%s assignment_strategy=%s topic=%s partition=%i&quot;</span> 
    <span class="i">s</span><span class="o">.</span><span class="i">memberId</span> <span class="i">s</span><span class="o">.</span><span class="i">protocolName</span> <span class="i">ms</span><span class="o">.</span><span class="i">topic</span> <span class="i">ms</span><span class="o">.</span><span class="i">partition</span> })
</code></pre></td>
</tr>
</table>
<p>The resulting stream merges all of the per-broker streams covering all assigned partitions of the consumed topic. Note that offsets
must be committed explicitly.</p>
<h2><a name="Consumer-Offsets" class="anchor" href="#Consumer-Offsets">Consumer Offsets</a></h2>
<p>Consumer offsets can be committed explicitly. This can be used to reset a consumer to a particular offset when
the consumer instances are offline. Note that consumer instances only fetch committed offsets when they are starting
to consumer, or when rejoining.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="i">Consumer</span><span class="o">.</span><span class="i">commitOffsets</span> <span class="i">consumer</span> [| <span class="n">0</span>, <span class="n">1L</span> |]
<span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>


<span class="i">Consumer</span><span class="o">.</span><span class="i">commitOffsetsToTime</span> <span class="i">consumer</span> <span class="i">Time</span><span class="o">.</span><span class="i">EarliestOffset</span>
<span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>
</code></pre></td>
</tr>
</table>
<p>Fetch committed consumer offsets:</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="k">let</span> <span class="i">consumerOffsets</span> <span class="o">=</span>
  <span class="i">Consumer</span><span class="o">.</span><span class="i">fetchOffsets</span> <span class="i">conn</span> <span class="s">&quot;consumer-group&quot;</span> [||]
  <span class="o">|&gt;</span> <span class="i">Async</span><span class="o">.</span><span class="i">RunSynchronously</span>

<span class="k">for</span> (<span class="i">t</span>,<span class="i">os</span>) <span class="k">in</span> <span class="i">consumerOffsets</span> <span class="k">do</span>
  <span class="k">for</span> (<span class="i">p</span>,<span class="i">o</span>) <span class="k">in</span> <span class="i">os</span> <span class="k">do</span>
    <span class="i">printfn</span> <span class="s">&quot;topic=%s partition=%i offset=%i&quot;</span> <span class="i">t</span> <span class="i">p</span> <span class="i">o</span>
</code></pre></td>
</tr>
</table>
<h2><a name="Rolling-Updates" class="anchor" href="#Rolling-Updates">Rolling Updates</a></h2>
<p>Kafka supports rolling updates of consumer group member instances. This can be done by having a newever version of
a consumer support both new and old versions of consumer group assignment strategies. The assignment strategy itself can
change, but the code path invoked by the consumer can also change. The Kafka group coordinator ensures that all members
of the group support the same protocol version. Once new versions have been deployed, all consumer instances will support
the new version and Kafka will select the first version in the list.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// This configuration specifies two versions of an assignment strategy.</span>
<span class="k">let</span> <span class="i">consumerConfigVersioned</span> <span class="o">=</span> 
  <span class="i">ConsumerConfig</span><span class="o">.</span><span class="i">create</span> (
    <span class="i">groupId</span> <span class="o">=</span> <span class="s">&quot;consumer-group&quot;</span>, 
    <span class="i">topic</span> <span class="o">=</span> <span class="s">&quot;absurd-topic&quot;</span>,
    <span class="i">assignmentStrategies</span> <span class="o">=</span> [|
        <span class="s">&quot;range/v2&quot;</span>, <span class="i">ConsumerGroup</span><span class="o">.</span><span class="i">AssignmentStratgies</span><span class="o">.</span><span class="i">Range</span>
        <span class="s">&quot;range/v1&quot;</span>, <span class="i">ConsumerGroup</span><span class="o">.</span><span class="i">AssignmentStratgies</span><span class="o">.</span><span class="i">Range</span> |])

<span class="c">/// The handler accepts a consumer group member state object, which contains</span>
<span class="c">/// the selected protocol version. This can be used to invoke different code paths.</span>
<span class="k">let</span> <span class="i">handle</span> (<span class="i">s</span><span class="o">:</span><span class="i">GroupMemberState</span>) (<span class="i">ms</span><span class="o">:</span><span class="i">ConsumerMessageSet</span>) <span class="o">=</span> <span class="i">async</span> {
  <span class="k">match</span> <span class="i">s</span><span class="o">.</span><span class="i">protocolName</span> <span class="k">with</span>
  | <span class="s">&quot;range/v2&quot;</span> <span class="k">-&gt;</span>
    <span class="i">printfn</span> <span class="s">&quot;running version 2&quot;</span>
  
  | <span class="s">&quot;range/v1&quot;</span> <span class="k">-&gt;</span>
    <span class="i">printfn</span> <span class="s">&quot;running version 1&quot;</span>

  | <span class="i">v</span> <span class="k">-&gt;</span> <span class="i">failwithf</span> <span class="s">&quot;unknown protocol_version=%s&quot;</span> <span class="i">v</span> }
</code></pre></td>
</tr>
</table>
<h2><a name="Contributing-and-copyright" class="anchor" href="#Contributing-and-copyright">Contributing and copyright</a></h2>
<p>The project is hosted on <a href="https://github.com/jet/kafunk">GitHub</a> where you can <a href="https://github.com/jet/kafunk/issues">report issues</a>, fork
the project and submit pull requests. If you're adding a new public API, please also
consider adding <a href="https://github.com/jet/kafunk/docs/content">samples</a> that can be turned into a documentation. You might
also want to read the <a href="https://github.com/jet/kafunk/project/README.md">library design notes</a> to understand how it works.</p>
<p>The library is available under Apache 2.0. For more information see the
<a href="https://github.com/jet/kafunk/project/LICENSE.txt">License file</a> in the GitHub repository.</p>


        </div>
        <div class="span3">
          <img src="/kafunk/img/logo.png" alt="F# Project" style="width:150px;margin:10px" />  
          <ul class="nav nav-list" id="menu" style="margin-top: 20px;">
            <li class="nav-header">Kafunk</li>
            <li><a href="/kafunk/index.html">Home page</a></li>
            <li class="divider"></li>
            <li><a href="http://nuget.org/packages/kafunk">Get Library via NuGet</a></li>
            <li><a href="http://github.com/jet/kafunk">Source Code on GitHub</a></li>
            <li><a href="/kafunk/license.html">License</a></li>
            <li><a href="/kafunk/release-notes.html">Release Notes</a></li>
            
            <li class="nav-header">Getting started</li>
            <li><a href="/kafunk/consuming.html">Consuming</a></li>
            <li><a href="/kafunk/producing.html">Producing</a></li>

            <li class="nav-header">Documentation</li>
            <li><a href="/kafunk/reference/index.html">API Reference</a></li>
          </ul>
        </div>
      </div>
    </div>
    <a href="http://github.com/jet/kafunk"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"/></a>
  </body>
  </html>
